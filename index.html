<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenPoints App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- QR Scanner will be loaded dynamically -->
    <!-- Firebase compat builds (namespace: window.firebase) -->
    <!-- Using a stable SDK version -->
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
    <script>
      // Initialize Firebase (compat)
      const firebaseConfig = {
        apiKey: "AIzaSyCPCIj4lDZxrVaik-V5AWgAramnRx1bq7E",
        authDomain: "greenpoints-a167b.firebaseapp.com",
        projectId: "greenpoints-a167b",
        storageBucket: "greenpoints-a167b.firebasestorage.app",
        messagingSenderId: "865019744532",
        appId: "1:865019744532:web:596f76dd99d60192787201"
      };
      firebase.initializeApp(firebaseConfig);
      // Set auth persistence with graceful fallback
      (async () => {
        try {
          await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        } catch (e) {
          try {
            await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);
          } catch (e2) {
            console.warn('Auth persistence unavailable in this environment');
          }
        }
      })();
    </script>
    <style>
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0, 0, 0);
            }
            40%, 43% {
                transform: translate3d(0, -15px, 0);
            }
            70% {
                transform: translate3d(0, -7px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .font-sans {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* Premium device frame wrapper enforcing 9:16 aspect */
        .device-shell {
            width: min(100vw - 2rem, 430px);
            aspect-ratio: 9 / 16;
        }
        .device-bezel {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.08);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.45),
                inset 0 0 0 1px rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            overflow: hidden;
        }
        .device-screen {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            overflow: auto;
        }
        /* Ensure QR video fills its container */
        #qr-reader, #vendor-qr-reader { width: 100%; height: 100%; }
        #qr-reader video, #vendor-qr-reader video { width: 100% !important; height: 100% !important; object-fit: cover; }
    </style>
 </head>
<body class="min-h-screen flex items-center justify-center p-4 bg-white overflow-hidden font-sans">
    <div class="device-shell">
        <div class="device-bezel">
            <div id="app" class="device-screen">
                <!-- App content will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // Defensive guard: warn if Firebase failed to load
        if (!window.firebase) {
            window.addEventListener('load', () => {
                if (!window.firebase) {
                    alert('Firebase failed to load. Check network/ad-blockers and try again.');
                }
            });
        }
        
        // App state
        let currentScreen = 'login';
        let userPoints = 245;
        let showConfetti = false;
        let onboardingStep = 0;
        let scanningQR = false;
        let qrScanner = null;
        let hasCameraPermission = null;
        let selectedReward = null;
        let showRedemptionQR = false;
        let activeTab = 'individual';
        let currentUser = null;
        let userData = null;
        let isLoading = false;
        let authError = null;
        let currentRedemption = null;
        let isVendorMode = false;
        let vendorData = null;
        let rtdb = null;
        let previewStream = null; // fallback preview stream when QR lib fails

        // Data
        const rewards = [
            { id: 1, name: 'Canteen 20% Off', category: 'food', points: 50, icon: 'coffee', color: 'bg-orange-100 text-orange-600' },
            { id: 2, name: 'Free Notebook', category: 'food', points: 80, icon: 'book-open', color: 'bg-blue-100 text-blue-600' },
            { id: 4, name: 'Pizza Combo', category: 'food', points: 120, icon: 'coffee', color: 'bg-red-100 text-red-600' },
            { id: 5, name: 'Eco Bag', category: 'stationery', points: 60, icon: 'book-open', color: 'bg-green-100 text-green-600' },
        ];

        const leaderboard = [
            { rank: 1, name: 'Sarah Chen', points: 1250, dept: 'Computer Science', badge: 'Zero-Waste Hero' },
            { rank: 2, name: 'Alex Kumar', points: 1180, dept: 'Mechanical Eng', badge: 'Plastic Smasher' },
            { rank: 3, name: 'Maya Patel', points: 950, dept: 'Environmental Sci', badge: 'Eco Champion' },
            { rank: 4, name: 'You', points: userPoints, dept: 'Computer Science', badge: 'Green Rookie' },
            { rank: 5, name: 'John Smith', points: 220, dept: 'Business Admin', badge: 'Green Rookie' }
        ];

        const teamLeaderboard = [
            { rank: 1, name: 'Computer Science', points: 12500, members: 45 },
            { rank: 2, name: 'Mechanical Engineering', points: 11200, members: 38 },
            { rank: 3, name: 'Environmental Science', points: 9800, members: 28 }
        ];

        const badges = [
            { name: 'Green Rookie', desc: 'Started your eco journey', unlocked: true, icon: 'ðŸŒ±' },
            { name: 'Plastic Smasher', desc: 'Recycled 50+ plastic items', unlocked: false, icon: 'â™»ï¸' },
            { name: 'Eco Champion', desc: 'Reach 500 GreenPoints', unlocked: false, icon: 'ðŸ†' },
            { name: 'Zero-Waste Hero', desc: 'Recycled for 30 days straight', unlocked: false, icon: 'â­' }
        ];

        const recyclingHistory = [
            { date: '2025-09-23', type: 'Plastic Bottle', points: 10, bin: 'BIN-CLG-2025-001' },
            { date: '2025-09-22', type: 'Paper Cup', points: 5, bin: 'BIN-CLG-2025-003' },
            { date: '2025-09-21', type: 'Aluminum Can', points: 15, bin: 'BIN-CLG-2025-002' },
            { date: '2025-09-20', type: 'Plastic Bottle', points: 10, bin: 'BIN-CLG-2025-001' }
        ];

        // Firebase Authentication Functions
        async function signUpWithEmail(email, password, userInfo) {
            try {
                isLoading = true;
                authError = null;
                renderCurrentScreen();
                
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await firebase.firestore().collection('users').doc(user.uid).set({
                    email: user.email,
                    displayName: userInfo.name || user.email.split('@')[0],
                    department: userInfo.department || 'Computer Science',
                    points: 0,
                    totalRecycled: 0,
                    treesSaved: 0,
                    badges: ['Green Rookie'],
                    createdAt: new Date(),
                    lastLogin: new Date()
                });
                
                await loadUserData(user.uid);
                setCurrentScreen('onboarding');
            } catch (error) {
                authError = error.message;
                renderCurrentScreen();
            } finally {
                isLoading = false;
            }
        }

        async function signInWithEmail(email, password) {
            try {
                isLoading = true;
                authError = null;
                renderCurrentScreen();
                
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                await loadUserData(userCredential.user.uid);
                setCurrentScreen('home');
            } catch (error) {
                authError = error.message;
                renderCurrentScreen();
            } finally {
                isLoading = false;
            }
        }

        async function signInWithGoogle() {
            try {
                isLoading = true;
                authError = null;
                renderCurrentScreen();
                
                const provider = new firebase.auth.GoogleAuthProvider();
                const isMobile = /Mobi|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    await firebase.auth().signInWithRedirect(provider);
                    return;
                }
                try {
                    const result = await firebase.auth().signInWithPopup(provider);
                    const user = result.user;
                    await handlePostAuth(user);
                    setCurrentScreen('home');
                } catch (popupError) {
                    // Fallback to redirect on popup issues or policy blocks
                    await firebase.auth().signInWithRedirect(provider);
                }
            } catch (error) {
                authError = error.message;
                renderCurrentScreen();
            } finally {
                isLoading = false;
            }
        }

        async function signOut() {
            try {
                await firebase.auth().signOut();
                currentUser = null;
                userData = null;
                vendorData = null;
                isVendorMode = false;
                setCurrentScreen('login');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Shared post-auth handler for Google popup/redirect
        async function handlePostAuth(user) {
            // Check if user document exists
            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
            if (!userDoc.exists) {
                await firebase.firestore().collection('users').doc(user.uid).set({
                    email: user.email,
                    displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                    department: 'Computer Science',
                    points: 0,
                    totalRecycled: 0,
                    treesSaved: 0,
                    badges: ['Green Rookie'],
                    createdAt: new Date(),
                    lastLogin: new Date()
                });
            } else {
                await firebase.firestore().collection('users').doc(user.uid).update({ lastLogin: new Date() });
            }
            await loadUserData(user.uid);
        }

        async function loadUserData(uid) {
            try {
                const userDoc = await firebase.firestore().collection('users').doc(uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    userPoints = userData.points || 0;
                    currentUser = uid;
                    // init RTDB client if not yet
                    if (!rtdb && window.firebase && firebase.database) {
                        rtdb = firebase.database();
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadVendorData(uid) {
            try {
                const ref = firebase.firestore().collection('vendors').doc(uid);
                const snap = await ref.get();
                if (!snap.exists) {
                    await ref.set({
                        uid,
                        email: firebase.auth().currentUser?.email || '',
                        displayName: firebase.auth().currentUser?.displayName || 'Vendor',
                        balance: 0,
                        createdAt: new Date(),
                        lastLogin: new Date()
                    });
                    vendorData = { balance: 0 };
                } else {
                    vendorData = snap.data();
                    await ref.update({ lastLogin: new Date() });
                }
            } catch (e) {
                console.error('Error loading vendor data:', e);
            }
        }

        function setVendorMode(enabled) {
            isVendorMode = !!enabled;
        }

        async function updateUserPoints(pointsToAdd) {
            if (!currentUser) return;
            
            try {
                const newPoints = userPoints + pointsToAdd;
                await firebase.firestore().collection('users').doc(currentUser).update({ points: newPoints });
                userPoints = newPoints;
                
                // Add to recycling history
                await firebase.firestore().collection('recyclingHistory').add({
                    userId: currentUser,
                    type: 'Plastic Bottle', // This would come from QR scan
                    points: pointsToAdd,
                    bin: 'BIN-CLG-2025-001', // This would come from QR scan
                    timestamp: new Date()
                });
                
                renderCurrentScreen();
            } catch (error) {
                console.error('Error updating points:', error);
            }
        }

        // Redemption flow
        async function createRedemption(reward) {
            if (!currentUser) return null;
            const expiresAt = new Date(Date.now() + 5 * 60 * 1000);
            const redemptionDoc = {
                studentId: currentUser,
                rewardName: reward.name,
                points: reward.points,
                status: 'pending',
                createdAt: new Date(),
                expiresAt: expiresAt,
            };
            const ref = await firebase.firestore().collection('redemptions').add(redemptionDoc);
            return { id: ref.id, expiresAt };
        }

        async function processRedemption(redemptionId) {
            try {
                await firebase.firestore().runTransaction(async (tx) => {
                    const redRef = firebase.firestore().collection('redemptions').doc(redemptionId);
                    const snap = await tx.get(redRef);
                    if (!snap.exists) {
                        throw new Error('Invalid redemption');
                    }
                    const data = snap.data();
                    if (data.status !== 'pending') {
                        throw new Error('Already processed');
                    }
                    if (data.expiresAt && data.expiresAt.toDate && data.expiresAt.toDate() < new Date()) {
                        throw new Error('QR expired');
                    }
                    const studentRef = firebase.firestore().collection('users').doc(data.studentId);
                    const studentSnap = await tx.get(studentRef);
                    if (!studentSnap.exists) {
                        throw new Error('Student not found');
                    }
                    const student = studentSnap.data();
                    const studentNewPts = (student.points || 0) - data.points;
                    if (studentNewPts < 0) {
                        throw new Error('Insufficient points');
                    }
                    tx.update(studentRef, { points: studentNewPts });

                    // credit vendor balance
                    const vendorUid = firebase.auth().currentUser ? firebase.auth().currentUser.uid : null;
                    if (!vendorUid) {
                        throw new Error('Vendor not authenticated');
                    }
                    const vendorRef = firebase.firestore().collection('vendors').doc(vendorUid);
                    const vendorSnap = await tx.get(vendorRef);
                    const vendorBalance = vendorSnap.exists ? (vendorSnap.data().balance || 0) : 0;
                    if (!vendorSnap.exists) {
                        tx.set(vendorRef, { uid: vendorUid, balance: data.points, createdAt: new Date(), lastLogin: new Date() });
                    } else {
                        tx.update(vendorRef, { balance: vendorBalance + data.points });
                    }
                    tx.update(redRef, {
                        status: 'completed',
                        completedAt: new Date(),
                        vendorId: vendorUid
                    });
                });
                // Refresh local state if student is same user
                if (currentUser) {
                    await loadUserData(currentUser);
                }
                if (isVendorMode && firebase.auth().currentUser) {
                    await loadVendorData(firebase.auth().currentUser.uid);
                }
                alert('Redemption successful');
                setCurrentScreen('home');
            } catch (e) {
                alert('Redemption failed: ' + e.message);
            }
        }

        // Form handlers
        async function handleEmailLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            await signInWithEmail(email, password);
        }

        async function handleEmailRegister(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const department = document.getElementById('regDepartment').value;
            const password = document.getElementById('regPassword').value;
            
            await signUpWithEmail(email, password, { name, department });
        }

        // Helper functions
        function setCurrentScreen(screen) {
            // Stop any active scanners before navigation to avoid crashes
            try { if (qrScanner) { stopQrScanner(); } } catch (_) {}
            try { if (vendorScanner) { stopVendorScanner(); } } catch (_) {}
            currentScreen = screen;
            renderCurrentScreen();
        }

        // Click-gesture driven navigation that starts preview+scanner immediately
        async function goToScan() {
            currentScreen = 'scan';
            renderCurrentScreen();
            try {
                // Start preview right away under the same user gesture
                await showCameraPreviewFallback();
            } catch (_) {}
            // Also attempt to start the QR scanner right away
            try { await startQrScanner(); } catch (_) {}
        }

        async function startQrScanner() {
            if (qrScanner) return;
            const containerId = "qr-reader";
            try {
                scanningQR = true;
                renderCurrentScreen();
                const statusEl = document.getElementById('scan-status');
                if (statusEl) statusEl.textContent = 'Initializing camera...';
                // basic secure-context check
                if (!(location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
                    throw new Error('Camera requires HTTPS or localhost');
                }
                // test camera availability/permission first
                await ensureCameraAccess();
                if (statusEl) statusEl.textContent = 'Loading scanner...';
                // ensure library is loaded
                await ensureHtml5Qrcode();
                const mountEl = document.getElementById(containerId);
                if (!mountEl) throw new Error('Scanner container missing');
                if (window.Html5Qrcode) {
                    qrScanner = new Html5Qrcode(containerId, { verbose: false });
                } else {
                    console.warn('Scanner lib not loaded; using fallback preview only');
                    // Keep preview running, don't throw; user can still switch cameras
                    hasCameraPermission = true;
                    const cameras = await (navigator.mediaDevices?.enumerateDevices?.() || []);
                    if (!cameras || !cameras.length) throw new Error('No camera found');
                    if (statusEl) statusEl.textContent = 'Preview ready; QR engine unavailable (CDN blocked)';
                    return;
                }
                const constraintsList = [
                    { facingMode: 'environment' },
                    { facingMode: 'user' }
                ];
                let started = false;
                if (statusEl) statusEl.textContent = 'Starting camera...';
                for (const constraints of constraintsList) {
                    try {
                        await qrScanner.start(constraints, { fps: 8, qrbox: { width: 240, height: 240 }, aspectRatio: 1.3 }, onQrSuccess, onQrError);
                        started = true;
                        break;
                    } catch (_) {}
                }
                if (!started) {
                    // fallback: enumerate cameras
                    const cameras = await Html5Qrcode.getCameras();
                    if (!cameras || !cameras.length) throw new Error('No camera found');
                    const cameraId = cameras[0].id;
                    await qrScanner.start({ deviceId: { exact: cameraId } }, { fps: 8, qrbox: { width: 240, height: 240 }, aspectRatio: 1.3 }, onQrSuccess, onQrError);
                }
                if (statusEl) statusEl.textContent = 'Scanner ready';
                hasCameraPermission = true;
            } catch (e) {
                console.error('QR start error', e);
                hasCameraPermission = false;
                scanningQR = false;
                const statusEl = document.getElementById('scan-status');
                if (statusEl) statusEl.textContent = `Error: ${e && e.message ? e.message : 'Unknown error'}`;
                renderCurrentScreen();
                // Show selector regardless of outcome
                try { await populateCameraSelector(); } catch (_) {}
                // Fallback: show plain camera preview so users still see the camera
                try { await showCameraPreviewFallback(); } catch (_) {}
                setTimeout(() => alert('Unable to access camera: ' + (e && e.message ? e.message : e) + '\nTips: Close other apps using camera, ensure permission allowed, try switching camera below.'), 0);
            }
        }

        async function stopQrScanner() {
            try {
                if (qrScanner) {
                    await qrScanner.stop();
                    await qrScanner.clear();
                }
            } catch (_) {}
            qrScanner = null;
            scanningQR = false;
            // stop fallback preview if running
            try {
                if (previewStream) {
                    previewStream.getTracks().forEach(t => t.stop());
                }
            } catch (_) {}
            previewStream = null;
            const mount = document.getElementById('qr-reader');
            if (mount) {
                const vid = mount.querySelector('video[data-fallback="1"]');
                if (vid) {
                    try { vid.srcObject = null; } catch (_) {}
                    vid.remove();
                }
            }
        }

        async function showCameraPreviewFallback(deviceId) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
            const mount = document.getElementById('qr-reader');
            if (!mount) return;
            // If already showing fallback, do nothing
            const existing = mount.querySelector('video[data-fallback="1"]');
            if (existing) return;
            // Try multiple constraint options for robustness
            const options = [
                deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: { facingMode: 'environment' } },
                { video: { facingMode: 'user' } },
                { video: true }
            ];
            let stream = null;
            for (const c of options) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia(c);
                    break;
                } catch (_) {}
            }
            if (!stream) throw new Error('Unable to start camera preview');
            try {
                previewStream = stream;
                const video = document.createElement('video');
                video.setAttribute('data-fallback', '1');
                video.autoplay = true;
                video.playsInline = true;
                video.muted = true;
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.srcObject = previewStream;
                mount.appendChild(video);
                try { await video.play(); } catch (_) {}
                const statusEl = document.getElementById('scan-status');
                if (statusEl) statusEl.textContent = 'Camera preview ready (fallback)';
            } catch (err) {
                const statusEl = document.getElementById('scan-status');
                if (statusEl) statusEl.textContent = 'Preview failed: ' + (err && err.message ? err.message : err);
            }
        }

        // Navigate away from scan screen instantly and stop scanner in background
        function handleScanBack() {
            setCurrentScreen('home');
            // Stop scanner after navigation to avoid UI hang
            Promise.resolve().then(() => stopQrScanner()).catch(()=>{});
        }

        async function onQrSuccess(decodedText) {
            await stopQrScanner();
            // Try parse JSON to detect redemption vs bin
            let payload = null;
            try { payload = JSON.parse(decodedText); } catch (_) {}
            if (payload && payload.kind === 'redemption' && payload.id) {
                // treat as redemption QR: show confetti via points update is not applicable here
                alert('This QR is for redemption. Please show it to the vendor.');
                setCurrentScreen('home');
                return;
            }
            // Assume bin QR: expected formats: {binId:"..."} or plain BIN-...
            let binId = null;
            if (payload && payload.binId) binId = String(payload.binId);
            if (!binId && /^BIN-/.test(decodedText)) binId = decodedText.trim();
            if (!binId) {
                alert('Unrecognized QR');
                setCurrentScreen('home');
                return;
            }
            try {
                if (!currentUser) {
                    alert('Please sign in first.');
                    setCurrentScreen('login');
                    return;
                }
                if (!rtdb && window.firebase && firebase.database) {
                    rtdb = firebase.database();
                }
                if (!rtdb) throw new Error('RTDB not initialized');
                const commandRef = rtdb.ref(`bins/${binId}/command`);
                await commandRef.set({ state: 'open', userId: currentUser, ts: Date.now() });
                // Fallback: if backend doesn't credit within 6s, credit locally (less secure)
                setTimeout(async () => {
                    try {
                        // No definitive signal; skip double-crediting by simple heuristic
                        await updateUserPoints(10);
                        alert('Credited 10 points (fallback).');
                    } catch (_) {}
                }, 6000);
                alert('Bin command sent. Please dispose your item.');
                setCurrentScreen('home');
            } catch (e) {
                alert('Failed to signal bin: ' + e.message);
                setCurrentScreen('home');
            }
        }

        function onQrError(_) {
            // ignore scan errors; library calls this frequently
        }

        function ensureHtml5Qrcode() {
            const sources = [
                'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.10/html5-qrcode.min.js',
                'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/dist/html5-qrcode.min.js',
                'https://unpkg.com/html5-qrcode@2.3.10/dist/html5-qrcode.min.js',
                'https://unpkg.com/html5-qrcode/dist/html5-qrcode.min.js',
                'https://cdn.jsdelivr.net/gh/mebjas/html5-qrcode@v2.3.10/minified/html5-qrcode.min.js'
            ];
            return new Promise((resolve) => {
                if (window.Html5Qrcode) return resolve();
                const tryLoad = (idx) => {
                    if (idx >= sources.length) {
                        console.warn('All html5-qrcode sources failed; continuing without scanner lib');
                        window.__qrLibFailed = true;
                        return resolve();
                    }
                    const existing = document.querySelector(`script[data-qr="html5-qrcode-${idx}"]`);
                    if (existing) {
                        existing.addEventListener('load', () => resolve());
                        existing.addEventListener('error', () => tryLoad(idx + 1));
                        return;
                    }
                    const s = document.createElement('script');
                    s.src = sources[idx];
                    s.async = true;
                    s.defer = true;
                    s.setAttribute('data-qr', `html5-qrcode-${idx}`);
                    s.onload = () => { console.info('Loaded html5-qrcode from', sources[idx]); resolve(); };
                    s.onerror = () => tryLoad(idx + 1);
                    document.head.appendChild(s);
                };
                tryLoad(0);
            });
        }

        // Lightweight QR code generator loader (for rendering redemption QR locally)
        function ensureQrcodeLib() {
            const sources = [
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js'
            ];
            return new Promise((resolve, reject) => {
                if (window.QRCode && (window.QRCode.toCanvas || window.QRCode.toDataURL)) return resolve();
                const tryLoad = (idx) => {
                    if (idx >= sources.length) return reject(new Error('Failed to load QR generator'));
                    const existing = document.querySelector(`script[data-qrgen="qrcode-${idx}"]`);
                    if (existing) {
                        existing.addEventListener('load', () => resolve());
                        existing.addEventListener('error', () => tryLoad(idx + 1));
                        return;
                    }
                    const s = document.createElement('script');
                    s.src = sources[idx];
                    s.async = true;
                    s.defer = true;
                    s.setAttribute('data-qrgen', `qrcode-${idx}`);
                    s.onload = () => { console.info('Loaded QR generator from', sources[idx]); resolve(); };
                    s.onerror = () => tryLoad(idx + 1);
                    document.head.appendChild(s);
                };
                tryLoad(0);
            });
        }

        async function renderRedemptionQr() {
            try {
                await ensureQrcodeLib();
                const mount = document.getElementById('redemption-qr');
                if (!mount || !currentRedemption || !currentRedemption.id) return;
                // Clear previous
                mount.innerHTML = '';
                // Prefer canvas for crispness
                if (window.QRCode && window.QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    const payload = JSON.stringify({
                        v: 1,
                        kind: 'redemption',
                        id: String(currentRedemption.id),
                        rewardName: currentRedemption.reward?.name,
                        points: currentRedemption.reward?.points,
                        exp: currentRedemption.expiresAt ? new Date(currentRedemption.expiresAt).toISOString() : null
                    });
                    await window.QRCode.toCanvas(canvas, payload, { width: 192, margin: 2, errorCorrectionLevel: 'M' });
                    mount.appendChild(canvas);
                } else if (window.QRCode && window.QRCode.toDataURL) {
                    const payload = JSON.stringify({
                        v: 1,
                        kind: 'redemption',
                        id: String(currentRedemption.id),
                        rewardName: currentRedemption.reward?.name,
                        points: currentRedemption.reward?.points,
                        exp: currentRedemption.expiresAt ? new Date(currentRedemption.expiresAt).toISOString() : null
                    });
                    const url = await window.QRCode.toDataURL(payload, { width: 192, margin: 2, errorCorrectionLevel: 'M' });
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = 'QR';
                    img.width = 192;
                    img.height = 192;
                    mount.appendChild(img);
                } else {
                    mount.textContent = 'QR library not available';
                }
            } catch (e) {
                console.error('Failed to render QR:', e);
                const mount = document.getElementById('redemption-qr');
                if (mount) mount.textContent = 'Failed to render QR: ' + e.message;
            }
        }

        async function generateBinQr() {
            try {
                await ensureQrcodeLib();
                const input = document.getElementById('bin-id-input');
                const binId = (input && input.value) ? input.value.trim() : '';
                const mount = document.getElementById('bin-qr');
                if (!mount) return;
                mount.innerHTML = '';
                if (!binId) {
                    mount.textContent = 'Enter a BIN ID';
                    return;
                }
                const payload = JSON.stringify({ v: 1, kind: 'bin', binId });
                if (window.QRCode && window.QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await window.QRCode.toCanvas(canvas, payload, { width: 192, margin: 2, errorCorrectionLevel: 'M' });
                    mount.appendChild(canvas);
                } else if (window.QRCode && window.QRCode.toDataURL) {
                    const url = await window.QRCode.toDataURL(payload, { width: 192, margin: 2, errorCorrectionLevel: 'M' });
                    const img = document.createElement('img');
                    img.src = url;
                    img.width = 192; img.height = 192;
                    mount.appendChild(img);
                } else {
                    mount.textContent = 'QR library not available';
                }
            } catch (e) {
                alert('Failed to generate QR: ' + e.message);
            }
        }

        async function ensureCameraAccess() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Camera API not available in this browser');
            }
            // Do not pre-open the camera stream here; it can cause NotReadableError.
            // Just verify that at least one video input device exists.
            const devices = await navigator.mediaDevices.enumerateDevices();
            const hasVideoInput = devices && devices.some(d => d.kind === 'videoinput');
            if (!hasVideoInput) {
                throw new Error('No camera found');
            }
        }

        async function handleRedeemReward(reward) {
            try {
                if (!currentUser) {
                    alert('Please sign in to redeem rewards.');
                    setCurrentScreen('login');
                    return;
                }
                if (userPoints < reward.points) {
                    alert('Not enough points');
                    return;
                }
                selectedReward = reward;
                const red = await createRedemption(reward);
                if (!red || !red.id) {
                    throw new Error('Failed to create redemption');
                }
                currentRedemption = { id: red.id, reward: reward, expiresAt: red.expiresAt };
                showRedemptionQR = true;
                renderCurrentScreen();
            } catch (e) {
                console.error('Redeem error:', e);
                alert('Could not start redemption: ' + (e && e.message ? e.message : 'Unknown error'));
            }
        }

        // Screen components
        function LoginScreen() {
            return `
                <div class="h-full bg-gradient-to-br from-green-50 to-emerald-100 flex flex-col justify-center p-6">
                    <div class="text-center mb-8">
                        <div class="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="leaf" class="w-8 h-8 text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-green-800 mb-2">GreenPoints</h1>
                        <p class="text-gray-600">Turn waste into rewards</p>
                    </div>
                    
                    ${authError ? `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            ${authError}
                        </div>
                    ` : ''}
                    
                    <div class="space-y-4">
                        <button
                            onclick="signInWithGoogle()"
                            ${isLoading ? 'disabled' : ''}
                            class="w-full bg-green-600 text-white py-4 rounded-2xl font-semibold text-lg hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                        >
                            ${isLoading ? '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>' : '<i data-lucide="mail" class="w-5 h-5"></i>'}
                            <span>Sign in with Google</span>
                        </button>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-green-50 text-gray-500">Or</span>
                            </div>
                        </div>
                        
                        <form onsubmit="handleEmailLogin(event)" class="space-y-4">
                            <div>
                                <input
                                    type="email"
                                    id="email"
                                    placeholder="College email"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm placeholder-gray-400 shadow-inner"
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    id="password"
                                    placeholder="Password"
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm placeholder-gray-400 shadow-inner"
                                />
                            </div>
                            <button
                                type="submit"
                                ${isLoading ? 'disabled' : ''}
                                class="w-full bg-green-600 text-white py-4 rounded-2xl font-semibold text-lg hover:bg-green-700 transition-colors disabled:opacity-50 shadow-lg ring-1 ring-emerald-400/30"
                            >
                                ${isLoading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                        
                        <div class="text-center">
                            <button
                                onclick="setCurrentScreen('register')"
                                class="text-green-600 hover:text-green-700 font-semibold"
                            >
                                Don't have an account? Sign up
                            </button>
                        </div>
                        <div class="text-center">
                            <button
                                onclick="setCurrentScreen('vendorLogin')"
                                class="text-gray-600 hover:text-gray-800 font-semibold text-sm mt-2 underline"
                            >
                                Vendor login
                            </button>
                        </div>
                        
                        <button
                            onclick="setCurrentScreen('onboarding')"
                            class="w-full border-2 border-green-600 text-green-600 py-4 rounded-2xl font-semibold text-lg hover:bg-green-50 transition-colors ring-1 ring-emerald-600/20 shadow-sm hover:shadow"
                        >
                            Continue as Guest
                        </button>
                    </div>
                </div>
            `;
        }

        function RegisterScreen() {
            return `
                <div class="h-full bg-gradient-to-br from-green-50 to-emerald-100 flex flex-col justify-center p-6">
                    <div class="text-center mb-8">
                        <div class="bg-green-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="leaf" class="w-8 h-8 text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-green-800 mb-2">Join GreenPoints</h1>
                        <p class="text-gray-600">Create your account to start earning</p>
                    </div>
                    
                    ${authError ? `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            ${authError}
                        </div>
                    ` : ''}
                    
                    <form onsubmit="handleEmailRegister(event)" class="space-y-4">
                        <div>
                            <input
                                type="text"
                                id="regName"
                                placeholder="Full name"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm placeholder-gray-400 shadow-inner"
                            />
                        </div>
                        <div>
                            <input
                                type="email"
                                id="regEmail"
                                placeholder="College email"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm placeholder-gray-400 shadow-inner"
                            />
                        </div>
                        <div>
                            <select
                                id="regDepartment"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm shadow-inner"
                            >
                                <option value="">Select Department</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Mechanical Engineering">Mechanical Engineering</option>
                                <option value="Environmental Science">Environmental Science</option>
                                <option value="Business Administration">Business Administration</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <input
                                type="password"
                                id="regPassword"
                                placeholder="Password (min 6 characters)"
                                required
                                minlength="6"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80 backdrop-blur-sm placeholder-gray-400 shadow-inner"
                            />
                        </div>
                        <button
                            type="submit"
                            ${isLoading ? 'disabled' : ''}
                            class="w-full bg-green-600 text-white py-4 rounded-2xl font-semibold text-lg hover:bg-green-700 transition-colors disabled:opacity-50 shadow-lg ring-1 ring-emerald-400/30"
                        >
                            ${isLoading ? 'Creating account...' : 'Create Account'}
                        </button>
                    </form>
                    
                    <div class="text-center mt-4">
                        <button
                            onclick="setCurrentScreen('login')"
                            class="text-green-600 hover:text-green-700 font-semibold"
                        >
                            Already have an account? Sign in
                        </button>
                    </div>
                </div>
            `;
        }

        function OnboardingScreen() {
            const slides = [
                {
                    icon: 'qr-code',
                    title: "Scan bin QR â†’ Drop waste â†’ Earn points",
                    desc: "Find any GreenPoints bin, scan the QR code, and dispose your recyclable waste responsibly."
                },
                {
                    icon: 'gift',
                    title: "Redeem instantly in canteen & stores",
                    desc: "Use your earned points for food discounts, stationery, and exclusive event perks."
                },
                {
                    icon: 'trophy',
                    title: "Climb the leaderboard & win badges",
                    desc: "Compete with friends, unlock achievements, and become the ultimate eco champion!"
                }
            ];

            const currentSlide = slides[onboardingStep];

            return `
                <div class="h-full bg-white flex flex-col">
                    <div class="flex-1 flex flex-col justify-center items-center p-6 text-center">
                        <div class="bg-green-100 w-24 h-24 rounded-full flex items-center justify-center mb-6">
                            <i data-lucide="${currentSlide.icon}" class="w-12 h-12 text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">${currentSlide.title}</h2>
                        <p class="text-gray-600 text-lg leading-relaxed">${currentSlide.desc}</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex justify-center space-x-2 mb-6">
                            ${slides.map((_, index) => 
                                `<div class="w-3 h-3 rounded-full ${index === onboardingStep ? 'bg-green-600 shadow shadow-emerald-400/30' : 'bg-gray-300'}"></div>`
                            ).join('')}
                        </div>
                        
                        <div class="flex space-x-4">
                            ${onboardingStep > 0 ? `
                                <button
                                    onclick="onboardingStep--; renderCurrentScreen()"
                                    class="flex-1 border border-gray-300 text-gray-600 py-3 rounded-xl font-semibold hover:shadow"
                                >
                                    Back
                                </button>
                            ` : ''}
                            <button
                                onclick="${onboardingStep < slides.length - 1 ? 'onboardingStep++; renderCurrentScreen()' : 'setCurrentScreen(\'home\')'}"
                                class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold shadow hover:shadow-lg"
                            >
                                ${onboardingStep < slides.length - 1 ? 'Next' : 'Get Started'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function HomeScreen() {
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-gradient-to-br from-green-700 via-emerald-600 to-teal-500 p-6 pb-28">
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <p class="text-emerald-100 text-sm">Welcome back</p>
                                <h1 class="text-white text-2xl font-extrabold tracking-tight">${userData ? userData.displayName : 'Eco Hero'}</h1>
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    onclick="setCurrentScreen('profile')"
                                    class="w-10 h-10 bg-white/15 hover:bg-white/25 transition rounded-full flex items-center justify-center ring-1 ring-white/20"
                                >
                                    <i data-lucide="user" class="w-5 h-5 text-white"></i>
                                </button>
                                <button
                                    onclick="setCurrentScreen('vendor')"
                                    class="w-10 h-10 bg-white/15 hover:bg-white/25 transition rounded-full flex items-center justify-center ring-1 ring-white/20"
                                    title="Vendor Dashboard"
                                >
                                    <i data-lucide="scan" class="w-5 h-5 text-white"></i>
                                </button>
                                <button
                                    onclick="signOut()"
                                    class="w-10 h-10 bg-white/15 hover:bg-white/25 transition rounded-full flex items-center justify-center ring-1 ring-white/20"
                                >
                                    <i data-lucide="log-out" class="w-5 h-5 text-white"></i>
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <div class="rounded-2xl p-5 bg-white/10 backdrop-blur-md ring-1 ring-white/20 shadow-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center ring-1 ring-white/30">
                                            <i data-lucide="coins" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <span class="text-white/90 font-semibold">GreenPoints</span>
                                    </div>
                                    <span class="text-white text-3xl font-extrabold">${userPoints}</span>
                                </div>
                                <div class="h-2 w-full bg-white/20 rounded-full overflow-hidden">
                                    <div class="h-full bg-white/90 rounded-full" style="width: ${Math.min((userPoints / 500) * 100, 100)}%"></div>
                                </div>
                                <div class="flex items-center justify-between mt-2">
                                    <p class="text-emerald-50 text-xs">Progress to Eco Champion</p>
                                    <p class="text-white text-xs font-semibold">${Math.max(0, 500 - userPoints)} pts left</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 -mt-20">
                        <button
                            onclick="goToScan()"
                            class="w-full bg-gradient-to-r from-emerald-600 to-green-600 text-white py-4 rounded-2xl font-bold text-lg mb-6 flex items-center justify-center gap-3 shadow-xl hover:shadow-2xl transition ring-1 ring-emerald-400/30"
                        >
                            <span class="inline-flex items-center gap-2">
                                <i data-lucide="camera" class="w-6 h-6"></i>
                                <span>Scan Bin QR</span>
                            </span>
                        </button>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button
                                onclick="setCurrentScreen('rewards')"
                                class="bg-white p-4 rounded-2xl shadow-md border border-gray-100 ring-1 ring-black/5 flex flex-col items-center gap-2 hover:shadow-lg transition"
                            >
                                <div class="w-11 h-11 rounded-xl bg-orange-50 flex items-center justify-center">
                                    <i data-lucide="gift" class="w-6 h-6 text-orange-500"></i>
                                </div>
                                <span class="font-semibold text-gray-800">Rewards Store</span>
                                <span class="text-xs text-gray-500">Redeem points instantly</span>
                            </button>
                            
                            <button
                                onclick="setCurrentScreen('leaderboard')"
                                class="bg-white p-4 rounded-2xl shadow-md border border-gray-100 ring-1 ring-black/5 flex flex-col items-center gap-2 hover:shadow-lg transition"
                            >
                                <div class="w-11 h-11 rounded-xl bg-yellow-50 flex items-center justify-center">
                                    <i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i>
                                </div>
                                <span class="font-semibold text-gray-800">Leaderboard</span>
                                <span class="text-xs text-gray-500">Climb the ranks</span>
                            </button>
                            
                            <button
                                onclick="setCurrentScreen('history')"
                                class="bg-white p-4 rounded-2xl shadow-md border border-gray-100 ring-1 ring-black/5 flex flex-col items-center gap-2 col-span-2 hover:shadow-lg transition"
                            >
                                <div class="w-11 h-11 rounded-xl bg-blue-50 flex items-center justify-center">
                                    <i data-lucide="history" class="w-6 h-6 text-blue-500"></i>
                                </div>
                                <span class="font-semibold text-gray-800">My Recycling History</span>
                                <span class="text-xs text-gray-500">Track your impact</span>
                            </button>
                            <button
                                onclick="setCurrentScreen('vendor')"
                                class="bg-white p-4 rounded-2xl shadow-md border border-gray-100 ring-1 ring-black/5 flex flex-col items-center gap-2 col-span-2 hover:shadow-lg transition"
                            >
                                <div class="w-11 h-11 rounded-xl bg-purple-50 flex items-center justify-center">
                                    <i data-lucide="scan-line" class="w-6 h-6 text-purple-600"></i>
                                </div>
                                <span class="font-semibold text-gray-800">Vendor Dashboard</span>
                                <span class="text-xs text-gray-500">Scan redemption QR</span>
                            </button>
                        </div>
                    </div>
                    
                    ${showConfetti ? `
                        <div class="absolute inset-0 pointer-events-none flex items-center justify-center z-50">
                            <div class="bg-green-600 text-white p-8 rounded-2xl shadow-2xl text-center animate-bounce">
                                <div class="text-6xl mb-4">ðŸŽ‰</div>
                                <h3 class="text-2xl font-bold mb-2">âœ… 10 GreenPoints earned!</h3>
                                <p class="text-green-100">Great job recycling!</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function ScanScreen() {
            // auto-start when entering scan screen
            setTimeout(() => startQrScanner(), 0);
            return `
                <div class="h-full bg-black relative">
                    <div class="fixed top-6 left-6 z-50 pointer-events-auto">
                        <button
                            onclick="handleScanBack()"
                            class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"
                            type="button" aria-label="Back"
                        >
                            <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center justify-center h-full">
                        <div class="relative">
                            <div class="w-72 h-72 border-4 border-white rounded-3xl relative overflow-hidden">
                                <div id="qr-reader" class="absolute inset-0" style="width:100%;height:100%;"></div>
                                <div class="pointer-events-none absolute inset-4 border-2 border-green-400 rounded-2xl"></div>
                            </div>
                            <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
                                <button
                                    onclick="startQrScanner()"
                                    class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg"
                                >
                                    <i data-lucide="camera" class="w-8 h-8 text-gray-800"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-6 left-6 right-6">
                        <div class="text-center">
                            <p class="text-white text-lg mb-2">Position QR code inside the frame</p>
                            <p id="scan-status" class="text-gray-300">Allow camera permission to start scanning</p>
                            <div class="mt-3 flex items-center justify-center gap-2">
                                <select id="camera-select" class="px-3 py-2 rounded bg-white text-gray-800 text-sm"></select>
                                <button onclick="switchSelectedCamera()" class="px-3 py-2 rounded bg-white/80 text-gray-800 text-sm" id="camera-switch-btn">Switch</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function populateCameraSelector() {
            await ensureHtml5Qrcode();
            const cameras = await Html5Qrcode.getCameras();
            const sel = document.getElementById('camera-select');
            const btn = document.getElementById('camera-switch-btn');
            if (!sel || !btn || !cameras || !cameras.length) return;
            sel.innerHTML = '';
            cameras.forEach((c) => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.label || c.id;
                sel.appendChild(opt);
            });
            sel.classList.remove('hidden');
            btn.classList.remove('hidden');
            // Default to first camera and start fallback preview immediately
            if (cameras[0] && !sel.value) {
                sel.value = cameras[0].id;
            }
            try { await showCameraPreviewFallback(sel.value || cameras[0]?.id); } catch (_) {}
        }

        async function switchSelectedCamera() {
            try {
                const sel = document.getElementById('camera-select');
                if (!sel || !sel.value) return;
                await stopQrScanner();
                await ensureHtml5Qrcode();
                qrScanner = new Html5Qrcode('qr-reader', { verbose: false });
                await qrScanner.start({ deviceId: { exact: sel.value } }, { fps: 8, qrbox: { width: 240, height: 240 }, aspectRatio: 1.3 }, onQrSuccess, onQrError);
                const statusEl = document.getElementById('scan-status');
                if (statusEl) statusEl.textContent = 'Scanner ready';
            } catch (e) {
                // If switching the qr scanner fails, at least show plain preview
                try { await showCameraPreviewFallback(document.getElementById('camera-select')?.value); } catch (_) {}
                alert('Failed to switch camera: ' + e.message);
            }
        }

        function RewardsScreen() {
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-white shadow-sm p-6 border-b">
                        <div class="flex items-center space-x-4 mb-4">
                            <button
                                onclick="setCurrentScreen('home')"
                                class="p-2 -ml-2 rounded-full hover:bg-gray-100"
                            >
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h1 class="text-2xl font-bold text-gray-800">Rewards Store</h1>
                        </div>
                        <div class="bg-green-100 p-3 rounded-xl">
                            <p class="text-green-800 font-semibold">Your Balance: ${userPoints} GreenPoints</p>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            ${rewards.map((reward) => {
                                const canAfford = userPoints >= reward.points;
                                
                                return `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${reward.color}">
                                                    <i data-lucide="${reward.icon}" class="w-6 h-6"></i>
                                                </div>
                                                <div>
                                                    <h3 class="font-semibold text-gray-800">${reward.name}</h3>
                                                    <p class="text-green-600 font-bold">${reward.points} pts</p>
                                                </div>
                                            </div>
                                            <button
                                                onclick="handleRedeemReward(${JSON.stringify(reward).replace(/"/g, '&quot;')})"
                                                ${!canAfford ? 'disabled' : ''}
                                                class="${canAfford 
                                                    ? 'bg-green-600 text-white hover:bg-green-700' 
                                                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'} px-4 py-2 rounded-lg font-semibold"
                                            >
                                                Redeem
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    ${showRedemptionQR && selectedReward ? `
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
                            <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
                                <h3 class="text-xl font-bold mb-4">Redemption QR Code</h3>
                                <div class="w-48 h-48 mx-auto bg-gray-50 rounded-xl mb-4 flex items-center justify-center overflow-hidden">
                                    <div id="redemption-qr" class="w-48 h-48 flex items-center justify-center"></div>
                                </div>
                                <p class="text-gray-600 mb-2">Show this to the vendor</p>
                                <p class="text-sm text-red-500 font-semibold">Expires in 5 minutes</p>
                                <p class="text-lg font-bold mt-2">${selectedReward.name}</p>
                                <button
                                    onclick="showRedemptionQR = false; selectedReward = null; currentRedemption = null; renderCurrentScreen()"
                                    class="mt-4 w-full bg-gray-200 text-gray-800 py-2 rounded-lg"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function LeaderboardScreen() {
            // Update user points in leaderboard
            leaderboard[3].points = userPoints;
            
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-white shadow-sm p-6 border-b">
                        <div class="flex items-center space-x-4 mb-4">
                            <button
                                onclick="setCurrentScreen('home')"
                                class="p-2 -ml-2 rounded-full hover:bg-gray-100"
                            >
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h1 class="text-2xl font-bold text-gray-800">Leaderboard</h1>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button
                                onclick="activeTab = 'individual'; renderCurrentScreen()"
                                class="px-4 py-2 rounded-lg font-semibold transition-colors ${
                                    activeTab === 'individual'
                                        ? 'bg-green-600 text-white'
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }"
                            >
                                Individual
                            </button>
                            <button
                                onclick="activeTab = 'team'; renderCurrentScreen()"
                                class="px-4 py-2 rounded-lg font-semibold transition-colors ${
                                    activeTab === 'team'
                                        ? 'bg-green-600 text-white'
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }"
                            >
                                Teams
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        ${activeTab === 'individual' ? `
                            <div class="space-y-4">
                                ${leaderboard.map((user, index) => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border ${
                                        user.name === 'You' ? 'border-green-500 bg-green-50' : 'border-gray-100'
                                    }">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                                                    index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-500' : 'bg-gray-300'
                                                }">
                                                    ${user.rank}
                                                </div>
                                                <div>
                                                    <h3 class="font-semibold ${user.name === 'You' ? 'text-green-800' : 'text-gray-800'}">
                                                        ${user.name}
                                                    </h3>
                                                    <p class="text-sm text-gray-500">${user.dept}</p>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-green-600">${user.points} pts</p>
                                                <p class="text-xs text-gray-500">${user.badge}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${teamLeaderboard.map((team, index) => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                                                    index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : 'bg-orange-500'
                                                }">
                                                    ${team.rank}
                                                </div>
                                                <div>
                                                    <h3 class="font-semibold text-gray-800">${team.name}</h3>
                                                    <p class="text-sm text-gray-500">${team.members} members</p>
                                                </div>
                                            </div>
                                            <p class="font-bold text-green-600">${team.points.toLocaleString()} pts</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                        
                        <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                            <p class="text-blue-800 text-sm font-semibold text-center">
                                ðŸ† Weekly reset in 3 days - Keep climbing!
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function ProfileScreen() {
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-500 p-6">
                        <div class="flex items-center space-x-4 mb-6">
                            <button
                                onclick="setCurrentScreen('home')"
                                class="p-2 -ml-2 rounded-full hover:bg-white/20"
                            >
                                <i data-lucide="arrow-left" class="w-5 h-5 text-white"></i>
                            </button>
                            <h1 class="text-2xl font-bold text-white">Profile & History</h1>
                        </div>
                        
                        <div class="bg-white/10 rounded-2xl p-4">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i data-lucide="user" class="w-8 h-8 text-white"></i>
                                </div>
                                <h2 class="text-white text-xl font-bold">${userData ? userData.displayName : 'User'}</h2>
                                <p class="text-green-100">${userData ? userData.department : 'Computer Science'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-100">
                                <i data-lucide="recycle" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800">12 kg</p>
                                <p class="text-sm text-gray-500">Waste Recycled</p>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-gray-100">
                                <i data-lucide="leaf" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800">3</p>
                                <p class="text-sm text-gray-500">Trees Saved</p>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center space-x-2">
                                <i data-lucide="award" class="w-5 h-5"></i>
                                <span>Your Badges</span>
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                ${badges.map((badge) => `
                                    <div class="p-3 rounded-lg border ${
                                        badge.unlocked ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'
                                    }">
                                        <div class="text-2xl mb-1">${badge.icon}</div>
                                        <h4 class="font-semibold text-sm ${badge.unlocked ? 'text-green-800' : 'text-gray-400'}">
                                            ${badge.name}
                                        </h4>
                                        <p class="text-xs ${badge.unlocked ? 'text-green-600' : 'text-gray-400'}">
                                            ${badge.desc}
                                        </p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button
                            onclick="setCurrentScreen('history')"
                            class="w-full bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center justify-between"
                        >
                            <div class="flex items-center space-x-3">
                                <i data-lucide="history" class="w-5 h-5 text-blue-500"></i>
                                <span class="font-semibold text-gray-800">View Full History</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function VendorDashboard() {
            if (!currentUser) {
                return `
                    <div class="h-full bg-gray-50 flex items-center justify-center p-6">
                        <div class="text-center">
                            <p class="text-gray-700 mb-4">Please sign in as a vendor to continue.</p>
                            <button onclick="setCurrentScreen('vendorLogin')" class="px-4 py-2 bg-emerald-600 text-white rounded-lg shadow">Vendor Login</button>
                        </div>
                    </div>
                `;
            }
            if (!isVendorMode) {
                return `
                    <div class="h-full bg-gray-50 flex items-center justify-center p-6">
                        <div class="text-center">
                            <p class="text-gray-700 mb-4">This dashboard is restricted to vendor accounts.</p>
                            <button onclick="setCurrentScreen('home')" class="px-4 py-2 bg-gray-200 rounded-lg">Go Home</button>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-white shadow-sm p-6 border-b">
                        <div class="flex items-center space-x-4 mb-4">
                            <button onclick="setCurrentScreen('home')" class="p-2 -ml-2 rounded-full hover:bg-gray-100">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h1 class="text-2xl font-bold text-gray-800">Vendor Dashboard</h1>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-gray-600">Scan student redemption QR to apply discount</p>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Balance</p>
                                <p class="text-xl font-bold text-emerald-600">${vendorData?.balance || 0} pts</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="bg-white rounded-2xl p-4 shadow-md border border-gray-100 ring-1 ring-black/5">
                            <div class="w-full max-w-sm mx-auto">
                                <div class="rounded-xl overflow-hidden border border-gray-200">
                                    <div class="relative">
                                        <div class="w-full h-72" id="vendor-qr-reader"></div>
                                        <div class="pointer-events-none absolute inset-3 border-2 border-emerald-400 rounded-xl"></div>
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-center">
                                    <button onclick="startVendorScanner()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg shadow ring-1 ring-emerald-400/30">Start Scanner</button>
                                    <button onclick="stopVendorScanner()" class="ml-2 px-4 py-2 bg-gray-200 rounded-lg shadow-sm">Stop</button>
                                </div>
                            </div>
                            <div id="vendor-status" class="text-center text-gray-600 text-sm mt-3"></div>
                        </div>
                        <div class="mt-6 bg-white rounded-2xl p-4 shadow border border-gray-100">
                            <h3 class="font-semibold text-gray-800 mb-3">Generate Bin QR</h3>
                            <div class="flex gap-2">
                                <input id="bin-id-input" class="flex-1 px-3 py-2 border rounded-lg" placeholder="BIN-CLG-2025-001" />
                                <button onclick="generateBinQr()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">Generate</button>
                            </div>
                            <div class="mt-4 flex justify-center">
                                <div id="bin-qr" class="w-48 h-48 bg-gray-50 rounded-lg flex items-center justify-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function VendorLoginScreen() {
            return `
                <div class="h-full bg-white flex flex-col justify-center p-6">
                    <div class="text-center mb-6">
                        <div class="bg-emerald-600 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="scan" class="w-7 h-7 text-white"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">Vendor Login</h1>
                        <p class="text-gray-600">Use your vendor account to access scanner</p>
                    </div>
                    <div class="space-y-3">
                        <button
                            onclick="(async()=>{ try{ isLoading=true; renderCurrentScreen(); const provider=new firebase.auth.GoogleAuthProvider(); const result=await firebase.auth().signInWithPopup(provider); if(result && result.user){ setVendorMode(true); await loadVendorData(result.user.uid); setCurrentScreen('vendor'); } } catch(e){ alert('Login failed: '+e.message); } finally{ isLoading=false; } })()"
                            class="w-full bg-emerald-600 text-white py-3 rounded-xl font-semibold hover:bg-emerald-700 transition"
                        >
                            Continue with Google
                        </button>
                        <button onclick="setCurrentScreen('login')" class="w-full border border-gray-300 py-3 rounded-xl font-semibold">Back to User Login</button>
                    </div>
                </div>
            `;
        }

        let vendorScanner = null;
        async function startVendorScanner() {
            try {
                await ensureCameraAccess();
                await ensureHtml5Qrcode();
                if (vendorScanner) return;
                vendorScanner = new Html5Qrcode('vendor-qr-reader');
                await vendorScanner.start(
                    { facingMode: 'environment' },
                    { fps: 10, qrbox: { width: 240, height: 240 } },
                    async (text) => {
                        document.getElementById('vendor-status').innerText = 'Processing...';
                        await stopVendorScanner();
                        let redemptionId = text;
                        try {
                            const parsed = JSON.parse(text);
                            if (parsed && parsed.kind === 'redemption' && parsed.id) {
                                redemptionId = parsed.id;
                            }
                        } catch (_) {}
                        await processRedemption(redemptionId);
                    },
                    () => {}
                );
                document.getElementById('vendor-status').innerText = 'Scanner ready';
            } catch (e) {
                document.getElementById('vendor-status').innerText = 'Error: ' + e.message;
            }
        }
        async function stopVendorScanner() {
            if (!vendorScanner) return;
            try { await vendorScanner.stop(); await vendorScanner.clear(); } catch (_) {}
            vendorScanner = null;
        }

        function HistoryScreen() {
            return `
                <div class="h-full bg-gray-50">
                    <div class="bg-white shadow-sm p-6 border-b">
                        <div class="flex items-center space-x-4">
                            <button
                                onclick="setCurrentScreen('profile')"
                                class="p-2 -ml-2 rounded-full hover:bg-gray-100"
                            >
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h1 class="text-2xl font-bold text-gray-800">Recycling History</h1>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            ${recyclingHistory.map((item) => `
                                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">${item.type}</h3>
                                            <p class="text-sm text-gray-500">${item.date}</p>
                                            <p class="text-xs text-gray-400">Bin: ${item.bin}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-green-600">+${item.points} pts</p>
                                            <i data-lucide="check" class="w-5 h-5 text-green-500 ml-auto mt-1"></i>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-6 p-4 bg-green-50 rounded-xl text-center">
                            <p class="text-green-800 font-semibold">ðŸŒ± Your recycling = 3 trees saved!</p>
                            <p class="text-green-600 text-sm mt-1">Keep up the great work!</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render function
        function renderCurrentScreen() {
            const app = document.getElementById('app');
            
            switch(currentScreen) {
                case 'login':
                    app.innerHTML = LoginScreen();
                    break;
                case 'register':
                    app.innerHTML = RegisterScreen();
                    break;
                case 'onboarding':
                    app.innerHTML = OnboardingScreen();
                    break;
                case 'home':
                    app.innerHTML = HomeScreen();
                    break;
                case 'scan':
                    app.innerHTML = ScanScreen();
                    populateCameraSelector().catch(()=>{});
                    // Start a lightweight camera preview immediately so users see video even if QR lib fails
                    try { showCameraPreviewFallback(); } catch (_) {}
                    // Add key handler for quick back from scan
                    try {
                        window.removeEventListener('keydown', __scanKeyHandler, true);
                    } catch (_) {}
                    window.addEventListener('keydown', __scanKeyHandler, true);
                    break;
                case 'rewards':
                    app.innerHTML = RewardsScreen();
                    break;
                case 'leaderboard':
                    app.innerHTML = LeaderboardScreen();
                    break;
                case 'profile':
                    app.innerHTML = ProfileScreen();
                    break;
                case 'vendor':
                    app.innerHTML = VendorDashboard();
                    break;
                case 'vendorLogin':
                    app.innerHTML = VendorLoginScreen();
                    break;
                case 'history':
                    app.innerHTML = HistoryScreen();
                    break;
                default:
                    app.innerHTML = LoginScreen();
            }
            
            // Initialize Lucide icons
            lucide.createIcons();

            // If redemption modal is open, render the QR locally
            if (showRedemptionQR && currentRedemption && currentRedemption.id) {
                renderRedemptionQr();
            }
        }

        // Key handler to exit scan on Esc/Backspace
        function __scanKeyHandler(ev) {
            if (currentScreen !== 'scan') return;
            if (ev.key === 'Escape' || ev.key === 'Backspace') {
                ev.preventDefault();
                handleScanBack();
            }
        }

        // Initialize app UI immediately
        renderCurrentScreen();

        // Handle Google redirect result on load (mobile-friendly)
        (async () => {
            try {
                const result = await firebase.auth().getRedirectResult();
                if (result && result.user) {
                    await handlePostAuth(result.user);
                    setCurrentScreen('home');
                }
            } catch (e) {
                console.warn('Auth redirect handling failed:', e);
            }
        })();

        // Attach Firebase auth state listener (compat)
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user.uid;
                loadUserData(user.uid).then(() => {
                    if (currentScreen === 'login' || currentScreen === 'register') {
                        setCurrentScreen('home');
                    }
                });
            } else {
                currentUser = null;
                userData = null;
                if (currentScreen !== 'login' && currentScreen !== 'register' && currentScreen !== 'onboarding') {
                    setCurrentScreen('login');
                }
            }
        });
    </script>
</body>
</html>
